#!/usr/bin/env bash
##Created by Edward "edge226" Tunnah.

## Checks the depends of a program and writes it to /tmp/lbf/

unset pkgname depends makedepends optdepends

source PKGBUILD
source /home/edge226/github/lucid/conf/lbf.vars ## This allows for the
	## usage of scanning an array of parameters to track in lbf.vars
unset origin

OPTIND=1 ## make sure the optargs are reset for getopts

while getopts "o:vph" opt; do
	case "$opt" in
		v)  verbose="yes";;
		p)  pretend="yes"
			verbose="yes";;
		o)  origin=$OPTARG;;
		h)  printf '%s\n' "$checkdeps_usage"; exit 0;;
		\?) printf '%s\n' "$checkdeps_usage" >&2; exit 1;;
	esac
done

for dep in "${depends[@]}"; do
	# lose the version comparator, if any
	depname=${dep%%[<>=]*}
	deps+=( "$depname" )
done

for dep in "${makedepends[@]}"; do
	# lose the version comparator, if any
	depname=${dep%%[<>=]*}
	makedeps+=( "$depname" )
done

for dep in "${checkdepends[@]}"; do
	# lose the version comaparator, if any
	depname=${dep%%[<>=]*}
	checkdeps+=( "$depname" )
done

for dep in "${optdepends[@]}"; do
	# lose the version comaparator, if any
	depname=${dep%%[<>=]*}
	optdeps+=( "$depname" )
done

arraytodir() {
	for depbase in "${checkdeps_arr[@]}"; do		
		typeset -n ref="$depbase"
		for entry in "${ref[@]}"; do
			mkdir -p "$tmploc/$depbase/$entry"
		done
	done
}

if [ "$verbose" = "yes" ]; then
	printf "$pkgname information:"
	printf '\n\n'
	printf "\nDirectory of the PKGBUILD file that originated the scan\n"
	printf "of the program.\n"
	pwd
	printf '\n\n'
	printf "\norigin is: \n"
	printf '%s\n' "$origin"
	printf '\n\n'
	printf "\ndeps are: \n"
	printf '%s\n' "${deps[@]}"
	printf '\n\n'
	printf "\nmakedeps: \n"
	printf '%s\n' "${makedeps[@]}"
	printf '\n\n'
	printf "\ncheckdeps: \n"
	printf '%s\n' "${checkdeps[@]}"
	printf '\n\n'
	printf "\noptdeps: \n"
	printf '%s\n' "${optdeps[@]}"
	printf '\n\n'
elif [ ! "$pretend" = "yes" ]; then
	if [ "$origin" = "" ] || [ "$origin" = "$pkgname" ]; then
		origin="$pkgname"
	elif [ ! "$origin" = "" ]; then
		origin="$origin/$pkgname"
	fi
	tmploc="/tmp/lbf/$origin"
	mkdir -p "$tmploc"
	pwd > "$tmploc/pkgb-loc"
	printf '%s\n' "$origin" > "$tmploc/origin"
	arraytodir
fi
exit 0
