#!/usr/bin/env bash
##Created by Edward "edge226" Tunnah.

## imports program usage from config files.
source /etc/lb/lb.usage
source /etc/lb/lb.conf

## The main stuff.

OPTIND=1 ## make sure the optargs are reset for getopts

## This case statement sets the build parameters of the program for
## which architecture to use.
while getopts "36d:hmt:r:b:vC" opt; do
    case "$opt" in
        d)  searchdir=$OPTARG;;
        6)  compilecmd="lucid-x86_64-build"
                buildarch="x86_64"
                printf "The build has been set to 64 bit.\n";;
        3)  compilecmd="lucid-i686-build"
                buildarch="i686"
                printf "The build has been set to 32 bit.\n";;
        m)  compilecmd="lucid-multilib-build"
                buildarch="x86_64"
                printf "The build has been set to multilib.\n";;
        t)  repodir=$OPTARG;;
        r)      repo=$OPTARG;;
        b)      branch=$OPTARG;;
        C)      cleanbuild="yes";;
        v)      verbose="yes";;
        h)      printf '%s\n' "$lb_usage"; exit 0;;
        \?)     printf '%s\n' "$lb_usage" >&2; exit 1;;
    esac
done

## Check for root! If the user is not running the script as root advise
## that root is required to operate this script and then drop out. If
## the script is run as root then continue.
if [ "$EUID" != "0" ]; then
    printf "error: This script must be run as root.\n"
    exit 1
else
    ## Finally find the pkgbuilds and build them!
    find "$searchdir" -name PKGBUILD -type f -execdir "$buildcmd" "$compilecmd" "$buildarch" "$repodir/$branch/$buildarch/$repo" "$verbose" "$cleanbuild"\;
fi
