#!/usr/bin/env bash
##Created by Edward "edge226" Tunnah.

## defines the usage of the program.
usage="
Name: 				lucid-build
  
Description:    	lucid-build compiles all PKGBUILD's recursively 
					within the working directory. It has options to
					modify where it starts searching and what
					architecture you would like to build within that
					working directory.
					
					Currently you can only use one architecture at
					a time but that will change.

Usage:				lucid-build (Options) [-d] <location>

Options: 		

	-h or --help 	You're reading it.
	
	-6				Compiles x86_64 packages.
	
	-3				Compiles i686 packages.
	
	-m				Compiles multilib packages.
					
	-d				Specifies the directory to start searching for
					PKGBUILD files.
Examples:		
	The following examples will compile packages for the appropriate 
	architecture starting in the current working directory.
	
	lb -6
	lb -3
	lb -m
	
	The following examples will compile packages for the appropriate
	architecture at the location you point it at.
	
	lb -6d /var/abs/core/pacman
	lb -3d /var/abs/core/pacman
	lb -md /var/abs/multilib/zsnes"
	

#findpkgbuild() {
#	## This stuff just finds pkgbuilds and then runs an inputted command
#	find "$dir" -name PKGBUILD -type f -print0 \
#		-execdir "$build $buildtype $repo" \;
#}

## The main stuff.

OPTIND=1 ## make sure the optargs are reset for getopts
buildtype="" ## makes sure there is a default set for build.
dir=""	 ## makes sure there is a default set for dir.

## This case statement sets the build parameters of the program for
## which architecture to use. 
while getopts "36d:hmr:" opt; do
	case "$opt" in
		d)	dir=$OPTARG;;
		6)	buildtype="unstable-x86_64-build"
				printf "The build has been set to 64 bit.\n";;
		3)	buildtype="unstable-i686-build"
				printf "The build has been set to 32 bit.\n";;
		m)	buildtype="unstable-multilib-build"
				printf "The build has been set to multilib.\n";;
		r)	repo=$OPTARG;;
		h)	printf printf '%s\n' "$usage"; exit 0;;
		\?)	printf printf '%s\n' "$usage" >&2; exit 1;;
	esac
done
if [ "$buildtype" = "" ]; then
	buildtype="unstable-x86_64-build"
	printf "The build has been set to 64 bit as default.\n"
else
	printf "The build environment being used is: $buildtype\n"
fi
if [ "$dir" = "" ]; then
	dir="./"
	printf "Finding packagebuilds in "pwd" directory.\n"
else 
	printf "Finding packagebuilds in $dir directory.\n"
fi
if [ "$repo" = "" ]; then
#	mkdir -p /var/repo
	repo=/var/repo
	printf "Using $repo as the default repository location\n"
else
	printf "Using $repo as the repository location\n"
fi

build="/home/edge/scripts/pkgbuild-interfacer/lucid-build"

find "$dir" -name PKGBUILD -type f -execdir "$buildtype" \;
## The next line will eventually be used to reference another script
## that will deal with moving packages and build information to a
## seperate location.
#find "$dir" -name PKGBUILD -type f -execdir "$build" "$buildtype" "$repo" \;
